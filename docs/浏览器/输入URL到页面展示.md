### 从输入 URL 到页面展示内容中间经过了哪些过程

1. URL 解析

- 地址解析

首先判断你输入的是一个合法的 URL 还是一个待搜索的关键词，并且根据你输入的内容进行自动完成、字符编码等操作。

- 检查本地缓存

查找要请求的资源是否存在于本地缓存中，如果存在，则直接从缓存中获取。

- DNS 查询

查找的步骤为: 浏览器缓存(浏览器会先检查是否在缓存中，没有则调用系统库函数进行查询) -> 操作系统缓存(操作系统也有自己的 DNS 缓存，但在这之前，会先检查域名是否存在本地的 Hosts 文件里，没有则向 DNS 服务器发送查询请求) -> 路由器缓存 -> ISP DNS 缓存(ISP DNS 就是在客户端电脑上设置的首选 DNS 服务器，它们在大多数情况下都会有缓存) -> 根域名服务器(在前面所有步骤没有缓存的情况下，本地 DNS 服务器会将请求转发到互联网上的根域)

引申的问题:

什么是 DNS 劫持

前端 dns-prefetch 优化，可以在 html 页面头部写入 dns 缓存地址，比如：

```html
<meta http-equiv="x-dns-prefetch-control" content="on" />
<link rel="dns-prefetch" href="http://bdimg.share.baidu.com" />
```

- ARP 请求

2. 建立连接

- 封装 TCP 数据包

- 浏览器与服务器建立 TCP 连接

3. 数据传输

- 浏览器发送 HTTP 请求到 web 服务器

- 服务器处理请求并发回一个响应

4. 浏览器渲染

构建 DOM 树、样式计算、布局、分层、绘制、分块、光栅化、合成。

渲染过程中涉及的线程: 主线程、工作线程、合成线程和光栅化线程

主线程将 html 文件转化为浏览器能够读懂的 DOM 树结构。其中会通过网络进程加载次级资源，遇到 js 会停止构建 DOM 树，并执行 js。

主线程将 css 文件转化为浏览器能够读懂的 styleSheets 结构，并将其中的属性标准化，最后计算每个节点的样式。

主线程通过得到的 DOM 树和 styleSheets 样式表合成一颗布局树并计算每个节点的具体位置。

主线程通过得到的布局树进行图层分层并得到一个图层树。

主线程通过分层树对每一个图层分解绘制指令，得到一个绘制指令列表。

合成线程对图层进行分块处理，并对视口区域内的图块进行位图转换，将得到的结果通过 GPU 进程存入到 GPU 显存中。

合成线程收集位图信息创建合成帧，并将消息通过 IPC 协议传给浏览器主进程，主进程收到消息后，会将页面内容绘制到内存中，最后再将内存显示在屏幕上。

### 浏览器收到服务器响应后执行渲染相关逻辑

解析 HTML，生成 DOM 树。

网页中常常包含图片、css、js 等资源文件，这些资源浏览器会去各种渠道获取（缓存、网络下载等）。在构建 DOM 树的时候主线程会去请求他们，相关资源会通过进程之间的通信（IPC）通知网络进程去下载这些资源。在遇到 **script** 标签的时候，解析 DOM 树的工作会暂停，等 js 代码执行完毕之后在去重新解析 DOM 树。

解析 CSS，生成 CSSOM 树

将 DOM 树和 CSSOM 树结合，生成渲染树(Render Tree)

Layout(回流)：根据生成的渲染树，进行回流(Layout)，得到节点的几何信息（位置，大小）

Painting(重绘)：根据渲染树以及回流得到的几何信息，得到节点的绝对像素

Display：将像素发送给 GPU，展示在页面上。（这一步其实还有很多内容，比如会在 GPU 将多个合成层合并为同一个层，并展示在页面中。而 css3 硬件加速的原理则是新建合成层，这里我们不展开，之后有机会会写一篇博客）
